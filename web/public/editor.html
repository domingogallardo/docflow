<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editor simple</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 1rem; max-width: 900px; }
    textarea { width: 100%; height: 60vh; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .row { display: flex; gap: .5rem; align-items: center; margin: .5rem 0; }
    button { padding: .5rem .75rem; }
    .status { margin-left: .75rem; font-size: .9rem; opacity: .8; }
    input[type="text"] { width: 280px; }
  </style>
</head>
<body>
  <h1>Editor simple de fichero</h1>
  <p>Edita el contenido de <code>/data/nota.txt</code> (en el host: <code>/opt/web-domingo/dynamic-data/nota.txt</code>).</p>

  <div class="row">
    <button id="saveBtn">Guardar</button>
    <span class="status" id="status"></span>
  </div>

  <textarea id="editor" placeholder="(vacío)"></textarea>

  <script>
    const FILE_URL = new URL('/data/nota.txt', window.location.origin).href;
    const statusEl = document.getElementById('status');
    const editor = document.getElementById('editor');

    function setStatus(msg) {
      statusEl.textContent = msg || '';
    }

    async function loadFile() {
      setStatus('Cargando…');
      try {
        const resp = await fetch(FILE_URL, {
          cache: 'no-store',
          credentials: 'include'
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const text = await resp.text();
        editor.value = text;
        setStatus('Cargado ✔');
      } catch (err) {
        setStatus('Error al cargar: ' + err.message);
      }
    }

    async function saveFile() {
      setStatus('Guardando…');
      try {
        const resp = await fetch(FILE_URL, {
          method: 'PUT',               // WebDAV write
          headers: { 'Content-Type': 'text/plain; charset=utf-8' },
          body: editor.value,
          cache: 'no-store',
          credentials: 'include'
        });
        if (resp.status === 401) {
          // Nginx pedirá BasicAuth; vuelve a intentar tras el prompt del navegador
          // En muchos navegadores, el prompt sale automáticamente al primer 401 en naveg. no programática.
        }
        if (!resp.ok) throw new Error('HTTP ' + resp.status + ' ' + (await resp.text()).slice(0,200));
        setStatus('Guardado ✔');
      } catch (err) {
        setStatus('Error al guardar: ' + err.message);
      }
    }

    document.getElementById('saveBtn').addEventListener('click', saveFile);

    // Carga inicial
    window.addEventListener('DOMContentLoaded', loadFile);
  </script>
</body>
</html>
